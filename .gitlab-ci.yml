include:
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/general.yml
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/test/test.yml
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/test/lint.yml
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/test/security.yml
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/build/dist.yml
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/publish/pypi.yml
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/docker/image.yml
    - project: "AlekSIS/official/AlekSIS"
      file: "/ci/deploy/review.yml"
    - project: "AlekSIS/official/AlekSIS"
      file: "/ci/deploy/trigger_dist.yml"
    - project: "AlekSIS/official/AlekSIS"
      file: /ci/deploy/pages.yml

lint:
  interruptible: true
  stage: test
  variables:
    REPO: ${WEBLATE_REPO:-$(echo "aleksis/$CI_PROJECT_NAME" | tr '[:upper:]' '[:lower:]')}
  before_script:
    - pip3 install wlc
    - id testuser || adduser --disabled-password --gecos "Test User" testuser
    - chown -R testuser .
    - git fetch origin master:master
  script:
    - sudo -u testuser tox -e lint,makemessages,lint-i18n
    - wlc --key $WEBLATE_API_KEY  --url https://translate.edugit.org/api/ -D repo $REPO
    - |
      if git diff $CI_COMMIT_SHA master --exit-code -G "^(msgid|msgstr)"; then
        echo "The translation files have been changed. Check if there are unmerged translations which could cause conflicts later:";
        wlc --key $WEBLATE_API_KEY --url https://translate.edugit.org/api/ repo $REPO \
        | grep -q -E -i -w "needs_commit: True|needs_merge: True|needs_push: True" \
        && (echo "Yes, there are unmerged translations. Please merge them before adding new changes to the translation files." && false) \
        || (echo "No, there are no unmerged translations. You're ready to merge your changes." && true)
      fi

i18n_ready:
  interruptible: true
  stage: test
  #only:
  #  - /^prepare-release.*$/
  variables:
    REPO: ${WEBLATE_REPO:-$(echo "aleksis/$CI_PROJECT_NAME" | tr '[:upper:]' '[:lower:]')}
  before_script:
    - pip3 install wlc
  script:
    - wlc --key $WEBLATE_API_KEY  --url https://translate.edugit.org/api/ -D repo $REPO
    - |
      wlc --key $WEBLATE_API_KEY --url https://translate.edugit.org/api/ repo $REPO \
      | grep -q -E -i -w "needs_commit: True|needs_merge: True|needs_push: True" \
      && (echo "There are unmerged translations. Please merge them before releasing a new version." && false)
